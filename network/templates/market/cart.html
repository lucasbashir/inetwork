{% extends "market/layout.html" %}

{% block body %}
    <h2>Watchlist</h2>

        <!-- Display all listings in watchlist -->
    <div class="row mx-3">
    {% for listing in listings %}
        <!-- Display each listing as a card -->
        <div class="card" style="width: 18rem;">
            <!-- Display the first listing image -->
            {% if listing.images.exists %}
                <img class="card-img-top" src="{{ listing.images.first.image.url }}" alt="{{ listing.title }}">
            {% endif %}
            <div class="card-body">
                <!-- Display listing title and description -->
                <p>{{listing.title}}</p>
                <!-- Display current bid price -->
                <p class="card-text"><strong>{{ listing.currency }}{{ listing.price.bid }}</strong></p>
                <!-- Link to the listing page -->
                <a href="{% url 'closedDetails' listing.id %}" class="btn btn-primary">See listing status</a>
            </div>
        </div>
    {% endfor %}
</div>
<button onclick="makePayment()">Pay now</button>
<script>
    let selectedCurrency;
    public_key = "{{ public_key }}"
    secret_key = "{{ secret_key }}"

    function makePayment() {
        const amount = "{{ listing.price.bid }}";
        const userEmail = "{{ user.email }}";
        const userName = "{{ user.username }}";
        const listing_id = "{{ listing.id }}";
        const listing_currency = "{{ listing.currency }}";
        let otp;

        const currencyDropdown = document.getElementById("currencyDropdown");
        const selectedCurrency = currencyDropdown.value;

        // Fetch the currency conversion rate from the ExchangeRate API
        fetch(`https://v6.exchangerate-api.com/v6/c39ce07e90bde74fa5a8ac76/latest/${listing_currency}`)
            .then(response => response.json())
            .then(data => {
                // Get the conversion rate for the selected currency
                const conversionRate = data.conversion_rates[selectedCurrency];
                const convertedAmount = amount * conversionRate;

                FlutterwaveCheckout({
                    public_key: public_key,
                    tx_ref: `auction-${listing_id}-${Date.now()}`,
                    amount: convertedAmount,
                    currency: selectedCurrency,
                    payment_options: "card, banktransfer, ussd",
                    redirect_url: "https://inetwork.pythonanywhere.com/auctions/pay/" + listing_id,
                    meta: {
                        consumer_id: "YOUR_CONSUMER_ID", // Replace "YOUR_CONSUMER_ID" with the actual value
                        consumer_mac: "92a3-912ba-1192a",
                    },
                    customer: {
                        email: userEmail,
                        phone_number: "08102909304",
                        name: userName,
                    },
                    customizations: {
                        title: "iNetwork",
                        description: "Payment for an awesome cruise",
                        logo: "https://www.logolynx.com/images/logolynx/22/2239ca38f5505fbfce7e55bbc0604386.jpeg",
                    },
                });

                flutterOtp();
                validateOtp();
            });
    }

    function flutterOtp() {
        const data = JSON.stringify({
            length: 7,
            customer: {
                name: "Flutterwave Developers",
                email: "developers@flutterwavego.com",
                phone: "2348000000000",
            },
            sender: "Flutterwave Inc.",
            send: true,
            medium: ["email", "whatsapp"],
            expiry: 5,
        });

        const url = "https://api.flutterwave.com/v3/otps";
        const headers = {
            Authorization: secret_key,
            "Content-Type": "application/json",
        };

        const config = {
            method: "POST",
            headers: headers,
            body: data,
        };

        fetch(url, config)
            .then((response) => response.json())
            .then((data) => {
                console.log(JSON.stringify(data));
            })
            .catch((error) => {
                console.log(error);
            });
    }

    function validateOtp() {
        const data = JSON.stringify({
            otp: "481208",
        });

        const url = "https://api.flutterwave.com/v3/otps/:reference/validate";
        const headers = {
            Authorization: secret_key,
            "Content-Type": "application/json",
        };

        const config = {
            method: "POST",
            headers: headers,
            body: data,
        };

        fetch(url, config)
            .then((response) => response.json())
            .then((data) => {
                console.log(JSON.stringify(data));
            })
            .catch((error) => {
                console.log(error);
            });
    }

    function updateFlutterwaveCurrency() {
        selectedCurrency = currencyDropdown.value;
        const amount = "{{ listing.price.bid }}";
        const listing_currency = "{{ listing.currency }}";

        // Fetch the currency conversion rate from the ExchangeRate API
        fetch(`https://v6.exchangerate-api.com/v6/c39ce07e90bde74fa5a8ac76/latest/${listing_currency}`)
            .then(response => response.json())
            .then(data => {
                // Get the conversion rate for the selected currency
                const conversionRate = data.conversion_rates[selectedCurrency];
                const convertedAmount = amount * conversionRate;

                document.getElementById("payment-amount").innerHTML = `Amount: ${selectedCurrency} ${convertedAmount.toFixed(2)}`;
            });
    }
</script>
</div>

{% endblock %}
